% CIS2 project
% Guanhao(Dean) Fu
% gfu3@jhu.edu

clear all
close all
clc

syms lu lf wp
FK = cell(2,2);
%% Input collected matrices from Unity to here
% Post 1 bottom left
bottom_left_s = [0.13734	0.62958	-0.76470	0.00000
-0.49919	0.71080	0.49555	0.00000
0.85554	0.31367	0.41190	0.00000
0.00000	0.00000	0.00000	1.00000];
            
bottom_left_e = [0.56252	-0.80795	-0.17548	lu
0.07400	0.26059	-0.96261	0.00000
0.82347	0.52850	0.20638	0.00000
0.00000	0.00000	0.00000	1.00000];
%bottom_left_e(2,4) = lu;

bottom_left_w = [0.99983	0.00000	0.01833	lf
0.00000	1.00000	0.00000	0.00000
-0.01833	0.00000	0.99983	0.00000
0.00000	0.00000	0.00000	1.00000];

%bottom_left_w(2,4) = lf;
%wrist2palm = [0 wp 0 1]';

wrist2palm = [0.2 0 0 1]'; % need to calibrate this as well

FK{1} = bottom_left_s*bottom_left_e*bottom_left_w*wrist2palm;

% Post 2 bottom right
bottom_right_s = [0.37035	0.81083	-0.45321	0.00000
-0.57213	0.58349	0.57637	0.00000
0.73178	0.04584	0.68000	0.00000
0.00000	0.00000	0.00000	1.00000];

bottom_right_e = [0.51172	-0.83955	-0.18248	lu
0.11371	0.27671	-0.95420	0.00000
0.85159	0.46754	0.23706	0.00000
0.00000	0.00000	0.00000	1.00000];

bottom_right_w = [0.99983	0.00000	0.01833	lf
0.00000	1.00000	0.00000	0.00000
-0.01833	0.00000	0.99983	0.00000
0.00000	0.00000	0.00000	1.00000];

FK{2} = bottom_right_s*bottom_right_e*bottom_right_w*wrist2palm;


% Post 3 top right
top_right_s = [0.36668	0.77474	-0.51510	0.00000
-0.29876	0.62239	0.72344	0.00000
0.88107	-0.11138	0.45969	0.00000
0.00000	0.00000	0.00000	1.00000];


top_right_e = [0.58173	-0.79833	-0.15576	lu
0.13273	0.28210	-0.95016	0.00000
0.80248	0.53206	0.27007	0.00000
0.00000	0.00000	0.00000	1.00000];

top_right_w = [0.99983	0.00000	0.01833	lf
0.00000	1.00000	0.00000	0.00000
-0.01833	0.00000	0.99983	0.00000
0.00000	0.00000	0.00000	1.00000];

FK{3} = top_right_s * top_right_e * top_right_w * wrist2palm;


% Post 4 top left
top_left_s = [0.03849	0.71089	-0.70225	0.00000
-0.26074	0.68557	0.67971	0.00000
0.96464	0.15694	0.21174	0.00000
0.00000	0.00000	0.00000	1.00000];

top_left_e = [0.61179	-0.78195	-0.11944	lf
0.11297	0.23581	-0.96521	0.00000
0.78291	0.57701	0.23260	0.00000
0.00000	0.00000	0.00000	1.00000];

top_left_w = [0.99983	0.00000	0.01832	lu
0.00000	1.00000	0.00000	0.00000
-0.01832	0.00000	0.99983	0.00000
0.00000	0.00000	0.00000	1.00000];

FK{4} = top_left_s * top_left_e * top_left_w * wrist2palm;

%%
% actual distance between calibration posts
length = 0.2525; %in meters
width = 0.185; %in meters
diag = sqrt(length^2+width^2);

d = [length, diag, width, length, width, diag, diag, width, length, width, diag, length];
objsum = 0;
for i = 1:4
    idx = [1 ,2, 3, 4];
    idx(find(idx == i)) = [];
    for j = 1:3
        e = abs(FK{i}-FK{idx(j)});
        e = e(1:3);
        e = norm(e);
        d((i-1)*3+j);
        obj = norm((e-d((i-1)*3+j)),1);
        objsum = objsum + obj;
    end
end

ht = matlabFunction(objsum)

%% change this according to ht
fun = @(x)abs(sqrt(abs(x(1).*(-5.251492126e-1)+x(2).*1.0222124744+3.77020256642328e-2).^2+abs(x(1).*5.879872e-3+x(2).*4.18799808e-2-3.62759448679936e-2).^2+abs(x(1).*(-1.427241226e-1)+x(2).*8.162915071e-1+6.86784244783026e-2).^2)-3.13019568078419e-1).*2.0+abs(sqrt(abs(x(1).*(-1.357074514e-1)+x(2).*8.126215071e-1+7.00215468682314e-2).^2+abs(x(1).*7.500983011e-1-x(2).*7.488424744e-1+7.4037839448378e-3).^2+abs(x(1).*(-9.79865851e-2)+x(2).*1.074100192e-1+1.74588115669912e-2).^2)-1.01e+2./4.0e+2).*2.0+abs(sqrt(abs(x(1).*9.21067131e-2-x(2).*1.4929e-1+1.88171333010024e-2).^2+abs(x(1).*7.0166712e-3-x(2).*3.67e-3+1.3431223899288e-3).^2+abs(x(1).*2.249490885e-1+x(2).*2.7337e-1+4.51058096090706e-2).^2)-3.7e+1./2.0e+2).*2.0+abs(sqrt(abs(x(1).*3.094929014e-1+x(2).*2.0043e-1+6.13568616960416e-2).^2+abs(x(1).*2.29961811e-2+x(2).*2.553e-2+2.9128057305438e-3).^2+abs(x(1).*4.086446408e-1+x(2).*2.2934e-1+8.224438586936e-2).^2)-3.13019568078419e-1).*2.0+abs(sqrt(abs(x(1).*(-1.209827662e-1)+x(2).*8.18800192e-2+1.45460058364474e-2).^2+abs(x(1).*(-4.406053997e-1)+x(2).*9.492724744e-1+5.39530777512038e-2).^2+abs(x(1).*5.443520922e-1-x(2).*5.832815071e-1+1.22228390011286e-2).^2)-3.7e+1./2.0e+2).*2.0+abs(sqrt(abs(x(1).*1.151028942e-1-x(2).*1.2376e-1+2.17299390315462e-2).^2+abs(x(1).*4.016279696e-1+x(2).*2.3301e-1+8.09012634794312e-2).^2+abs(x(1).*8.45438129e-2-x(2).*7.294e-2+1.6251052086971e-2).^2)-1.01e+2./4.0e+2).*2.0

%% Run fmincon
lb = [0,0]; % lower bound
ub = [1,1]; % upper bound
A = [];
b = [];
Aeq = [];
beq = [];
% lu starts at 0.26m, lf starts at 0.25m
x0 = [0.8,0.8];
x = fmincon(fun,x0,A,b,Aeq,beq,lb,ub)
%%
while (1)
bottom_left_e2 = [0.56252	-0.80795	-0.17548	0.30000
0.07400	0.26059	-0.96261	0.00000
0.82347	0.52850	0.20638	0.00000
0.00000	0.00000	0.00000	1.00000];
            
bottom_left_w2 = [0.99983	0.00000	0.01833	0.25000
0.00000	1.00000	0.00000	0.00000
-0.01833	0.00000	0.99983	0.00000
0.00000	0.00000	0.00000	1.00000];

bottom_right_e2 = [0.51172	-0.83955	-0.18248	0.30000
0.11371	0.27671	-0.95420	0.00000
0.85159	0.46754	0.23706	0.00000
0.00000	0.00000	0.00000	1.00000];

bottom_right_w2 = [0.99983	0.00000	0.01833	0.25000
0.00000	1.00000	0.00000	0.00000
-0.01833	0.00000	0.99983	0.00000
0.00000	0.00000	0.00000	1.00000];

top_right_e2 = [0.58173	-0.79833	-0.15576	0.3
0.13273	0.28210	-0.95016	0.00000
0.80248	0.53206	0.27007	0.00000
0.00000	0.00000	0.00000	1.00000];

top_right_w2 = [0.99983	0.00000	0.01833	0.25
0.00000	1.00000	0.00000	0.00000
-0.01833	0.00000	0.99983	0.00000
0.00000	0.00000	0.00000	1.00000];

top_left_e2 = [0.61179	-0.78195	-0.11944	0.3
0.11297	0.23581	-0.96521	0.00000
0.78291	0.57701	0.23260	0.00000
0.00000	0.00000	0.00000	1.00000];

top_left_w2 = [0.99983	0.00000	0.01832	0.25
0.00000	1.00000	0.00000	0.00000
-0.01832	0.00000	0.99983	0.00000
0.00000	0.00000	0.00000	1.00000];

test1 = bottom_left_s*bottom_left_e2*bottom_left_w2*wrist2palm;
test2 = bottom_right_s*bottom_right_e2*bottom_right_w2*wrist2palm;
test3 = top_right_s * top_right_e2 * top_right_w2 * wrist2palm;
test4 = top_left_s * top_left_e2 * top_left_w2 * wrist2palm;

break
end
%%
distance = test2-test3;
distance = distance(1:3);
distance = norm(distance);

matA = [test1 test2 test3 test4];
matA = matA(1:3,:);

matB = [0, 0, 0;
    length, 0, 0;
    length, width, 0;
    0, width, 0]';

% Calculate the registration from Arm to Phantom
F = registration(matA, matB)
cal1 = F*test1
cal2 = F*test2
cal3 = F*test3
cal4 = F*test4
% dist = matlabFunction(distance);
% obj = abs(distance-length)^2;
% ht = matlabFunction(obj);
% lb = [0];
% ub = [1];
% A = [];
% b = [];
% Aeq = [];
% beq = [];
% x0 = (lb + ub)/2;
% x = fmincon(ht,x0,A,b,Aeq,beq,lb,ub)
